@startuml Schedule Maintenance Flow

title Schedule Maintenance Flow

actor Administrator
participant "API Controller" as API
participant "MediatR" as MediatR
participant "ScheduleMaintenanceHandler" as Handler
participant "MaintenanceWindow" as Aggregate
participant "IMaintenanceWindowRepository" as Repo
participant "Event Dispatcher" as EventDispatcher
participant "Notification Service" as Notification

Administrator -> API: POST /api/maintenance/schedule
activate API

API -> MediatR: Send(ScheduleMaintenanceCommand)
activate MediatR

MediatR -> Handler: Handle(command)
activate Handler

Handler -> Aggregate: Schedule(scheduledStartTime,\nestimatedDuration, type, services)
activate Aggregate

Aggregate -> Aggregate: Create MaintenanceWindow
Aggregate -> Aggregate: AddDomainEvent(MaintenanceScheduledDomainEvent)
Aggregate --> Handler: MaintenanceWindow
deactivate Aggregate

Handler -> Repo: AddAsync(maintenanceWindow)
activate Repo
Repo --> Handler: Success
deactivate Repo

Handler -> Repo: SaveChangesAsync()
activate Repo
Repo --> Handler: Success
deactivate Repo

Handler -> EventDispatcher: DispatchEvents(domainEvents)
activate EventDispatcher

EventDispatcher -> Notification: Send maintenance notifications\nto affected services
activate Notification
Notification --> EventDispatcher: Notifications sent
deactivate Notification

EventDispatcher --> Handler: Events dispatched
deactivate EventDispatcher

Handler --> MediatR: ScheduleMaintenanceResponse
deactivate Handler

MediatR --> API: Response
deactivate MediatR

API --> Administrator: 201 Created (MaintenanceWindow)
deactivate API

@enduml

@startuml Execute Backup Flow

title Execute Backup Flow

participant "Backup Scheduler" as Scheduler
participant "BackupService" as Service
participant "MediatR" as MediatR
participant "StartBackupHandler" as StartHandler
participant "SystemBackup" as Aggregate
participant "ISystemBackupRepository" as Repo
participant "Backup Storage" as Storage
participant "CompleteBackupHandler" as CompleteHandler
participant "Event Dispatcher" as EventDispatcher
participant "Monitoring Service" as Monitoring

Scheduler -> Service: TriggerBackup(backupType)
activate Service

Service -> MediatR: Send(StartBackupCommand)
activate MediatR

MediatR -> StartHandler: Handle(command)
activate StartHandler

StartHandler -> Aggregate: Start(backupType)
activate Aggregate

Aggregate -> Aggregate: Create SystemBackup
Aggregate -> Aggregate: AddDomainEvent(BackupStartedDomainEvent)
Aggregate --> StartHandler: SystemBackup
deactivate Aggregate

StartHandler -> Repo: AddAsync(backup)
activate Repo
Repo --> StartHandler: Success
deactivate Repo

StartHandler -> Repo: SaveChangesAsync()
activate Repo
Repo --> StartHandler: Success
deactivate Repo

StartHandler -> EventDispatcher: DispatchEvents(domainEvents)
activate EventDispatcher
EventDispatcher -> Monitoring: Log backup started
EventDispatcher --> StartHandler: Events dispatched
deactivate EventDispatcher

StartHandler --> MediatR: BackupId
deactivate StartHandler
MediatR --> Service: BackupId
deactivate MediatR

Service -> Storage: PerformBackup(backupType)
activate Storage

alt Backup Successful
    Storage --> Service: BackupResult(size, location)
    deactivate Storage

    Service -> MediatR: Send(CompleteBackupCommand)
    activate MediatR

    MediatR -> CompleteHandler: Handle(command)
    activate CompleteHandler

    CompleteHandler -> Repo: GetByIdAsync(backupId)
    activate Repo
    Repo --> CompleteHandler: SystemBackup
    deactivate Repo

    CompleteHandler -> Aggregate: Complete(size, location)
    activate Aggregate
    Aggregate -> Aggregate: AddDomainEvent(BackupCompletedDomainEvent)
    Aggregate --> CompleteHandler: Updated
    deactivate Aggregate

    CompleteHandler -> Repo: UpdateAsync(backup)
    CompleteHandler -> Repo: SaveChangesAsync()

    CompleteHandler -> EventDispatcher: DispatchEvents(domainEvents)
    activate EventDispatcher
    EventDispatcher -> Monitoring: Log backup completed
    EventDispatcher --> CompleteHandler: Events dispatched
    deactivate EventDispatcher

    CompleteHandler --> MediatR: Success
    deactivate CompleteHandler
    MediatR --> Service: Success
    deactivate MediatR

else Backup Failed
    Storage --> Service: BackupException(reason)
    deactivate Storage

    Service -> MediatR: Send(FailBackupCommand)
    activate MediatR

    MediatR -> CompleteHandler: Handle(command)
    activate CompleteHandler

    CompleteHandler -> Repo: GetByIdAsync(backupId)
    activate Repo
    Repo --> CompleteHandler: SystemBackup
    deactivate Repo

    CompleteHandler -> Aggregate: Fail(failureReason)
    activate Aggregate
    Aggregate -> Aggregate: AddDomainEvent(BackupFailedDomainEvent)
    Aggregate --> CompleteHandler: Updated
    deactivate Aggregate

    CompleteHandler -> Repo: UpdateAsync(backup)
    CompleteHandler -> Repo: SaveChangesAsync()

    CompleteHandler -> EventDispatcher: DispatchEvents(domainEvents)
    activate EventDispatcher
    EventDispatcher -> Monitoring: Log backup failed with alerts
    EventDispatcher --> CompleteHandler: Events dispatched
    deactivate EventDispatcher

    CompleteHandler --> MediatR: Success
    deactivate CompleteHandler
    MediatR --> Service: Success
    deactivate MediatR
end

Service --> Scheduler: Backup completed
deactivate Service

@enduml

@startuml Handle System Error Flow

title Handle System Error Flow

participant "Application" as App
participant "Exception Handler" as ExceptionHandler
participant "MediatR" as MediatR
participant "RecordSystemErrorHandler" as Handler
participant "SystemError" as Aggregate
participant "ISystemErrorRepository" as Repo
participant "Event Dispatcher" as EventDispatcher
participant "Alerting Service" as Alerting
participant "Logging Service" as Logging

App -> App: Exception occurs
activate App

App -> ExceptionHandler: HandleException(exception, context)
activate ExceptionHandler

ExceptionHandler -> ExceptionHandler: Extract error details\n(type, message, stack trace)
ExceptionHandler -> ExceptionHandler: Determine severity\nand affected accounts

ExceptionHandler -> MediatR: Send(RecordSystemErrorCommand)
activate MediatR

MediatR -> Handler: Handle(command)
activate Handler

Handler -> Aggregate: Create(errorType, message,\nstackTrace, severity, affectedAccounts)
activate Aggregate

Aggregate -> Aggregate: Create SystemError
Aggregate -> Aggregate: AddDomainEvent(SystemErrorOccurredDomainEvent)
Aggregate --> Handler: SystemError
deactivate Aggregate

Handler -> Repo: AddAsync(systemError)
activate Repo
Repo --> Handler: Success
deactivate Repo

Handler -> Repo: SaveChangesAsync()
activate Repo
Repo --> Handler: Success
deactivate Repo

Handler -> EventDispatcher: DispatchEvents(domainEvents)
activate EventDispatcher

EventDispatcher -> Logging: Log error details
activate Logging
Logging --> EventDispatcher: Logged
deactivate Logging

alt Severity is High or Critical
    EventDispatcher -> Alerting: Send critical alerts\nto on-call team
    activate Alerting
    Alerting -> Alerting: Send SMS/Email/Slack
    Alerting --> EventDispatcher: Alerts sent
    deactivate Alerting
end

EventDispatcher --> Handler: Events dispatched
deactivate EventDispatcher

Handler --> MediatR: RecordSystemErrorResponse
deactivate Handler

MediatR --> ExceptionHandler: ErrorId
deactivate MediatR

ExceptionHandler --> App: Error recorded and handled
deactivate ExceptionHandler

App -> App: Continue graceful degradation
deactivate App

note over Aggregate, Alerting
    Critical errors trigger immediate alerts
    to ensure rapid response and resolution
end note

@enduml

@startuml Monitor Performance Flow

title Monitor Performance Flow

participant "Performance Monitor" as Monitor
participant "System Metrics" as Metrics
participant "MediatR" as MediatR
participant "RecordPerformanceMetricHandler" as Handler
participant "PerformanceMetric" as Aggregate
participant "IPerformanceMetricRepository" as Repo
participant "Event Dispatcher" as EventDispatcher
participant "Alerting Service" as Alerting
participant "Dashboard" as Dashboard

activate Monitor
loop Every monitoring interval
    Monitor -> Metrics: CollectMetrics()
    activate Metrics
    Metrics --> Monitor: MetricValues
    deactivate Metrics

    loop For each metric
        Monitor -> Monitor: Compare actual vs threshold

        Monitor -> MediatR: Send(RecordPerformanceMetricCommand)
        activate MediatR

        MediatR -> Handler: Handle(command)
        activate Handler

        Handler -> Aggregate: Record(metricName,\nthreshold, actual, duration)
        activate Aggregate

        Aggregate -> Aggregate: Create PerformanceMetric
        Aggregate -> Aggregate: Check if threshold exceeded

        alt Threshold Exceeded
            Aggregate -> Aggregate: AddDomainEvent(PerformanceThresholdExceededDomainEvent)
        end

        Aggregate --> Handler: PerformanceMetric
        deactivate Aggregate

        Handler -> Repo: AddAsync(metric)
        activate Repo
        Repo --> Handler: Success
        deactivate Repo

        Handler -> Repo: SaveChangesAsync()
        activate Repo
        Repo --> Handler: Success
        deactivate Repo

        Handler -> EventDispatcher: DispatchEvents(domainEvents)
        activate EventDispatcher

        EventDispatcher -> Dashboard: Update real-time metrics
        activate Dashboard
        Dashboard --> EventDispatcher: Updated
        deactivate Dashboard

        alt Threshold Exceeded
            EventDispatcher -> Alerting: Send performance alert
            activate Alerting
            Alerting -> Alerting: Notify operations team
            Alerting --> EventDispatcher: Alert sent
            deactivate Alerting
        end

        EventDispatcher --> Handler: Events dispatched
        deactivate EventDispatcher

        Handler --> MediatR: RecordPerformanceMetricResponse
        deactivate Handler

        MediatR --> Monitor: MetricId, ThresholdExceeded
        deactivate MediatR
    end
end
deactivate Monitor

note over Monitor, Dashboard
    Continuous monitoring ensures system
    performance stays within acceptable limits
    and alerts are sent when thresholds are exceeded
end note

@enduml

@startuml Start and Complete Maintenance Flow

title Start and Complete Maintenance Flow

participant "Maintenance Scheduler" as Scheduler
participant "MediatR" as MediatR
participant "StartMaintenanceHandler" as StartHandler
participant "MaintenanceWindow" as Aggregate
participant "IMaintenanceWindowRepository" as Repo
participant "Event Dispatcher" as EventDispatcher
participant "Notification Service" as Notification
participant "System Services" as Services
participant "CompleteMaintenanceHandler" as CompleteHandler

Scheduler -> Scheduler: Monitor scheduled maintenance
activate Scheduler

Scheduler -> MediatR: Send(StartMaintenanceCommand)
activate MediatR

MediatR -> StartHandler: Handle(command)
activate StartHandler

StartHandler -> Repo: GetByIdAsync(maintenanceId)
activate Repo
Repo --> StartHandler: MaintenanceWindow
deactivate Repo

StartHandler -> Aggregate: Start()
activate Aggregate
Aggregate -> Aggregate: Set StartTime and Status
Aggregate -> Aggregate: AddDomainEvent(MaintenanceStartedDomainEvent)
Aggregate --> StartHandler: Updated
deactivate Aggregate

StartHandler -> Repo: UpdateAsync(maintenanceWindow)
StartHandler -> Repo: SaveChangesAsync()

StartHandler -> EventDispatcher: DispatchEvents(domainEvents)
activate EventDispatcher

EventDispatcher -> Notification: Notify affected services\nmaintenance has started
activate Notification
Notification --> EventDispatcher: Notifications sent
deactivate Notification

EventDispatcher --> StartHandler: Events dispatched
deactivate EventDispatcher

StartHandler --> MediatR: Success
deactivate StartHandler
MediatR --> Scheduler: Success
deactivate MediatR

Scheduler -> Services: Perform maintenance tasks
activate Services
Services -> Services: Execute updates,\npatches, configurations
Services --> Scheduler: Maintenance completed
deactivate Services

Scheduler -> MediatR: Send(CompleteMaintenanceCommand)
activate MediatR

MediatR -> CompleteHandler: Handle(command)
activate CompleteHandler

CompleteHandler -> Repo: GetByIdAsync(maintenanceId)
activate Repo
Repo --> CompleteHandler: MaintenanceWindow
deactivate Repo

CompleteHandler -> Aggregate: Complete()
activate Aggregate
Aggregate -> Aggregate: Set CompletedTime,\nActualDuration, and Status
Aggregate -> Aggregate: AddDomainEvent(MaintenanceCompletedDomainEvent)
Aggregate --> CompleteHandler: Updated
deactivate Aggregate

CompleteHandler -> Repo: UpdateAsync(maintenanceWindow)
CompleteHandler -> Repo: SaveChangesAsync()

CompleteHandler -> EventDispatcher: DispatchEvents(domainEvents)
activate EventDispatcher

EventDispatcher -> Notification: Notify affected services\nmaintenance is complete
activate Notification
Notification --> EventDispatcher: Notifications sent
deactivate Notification

EventDispatcher --> CompleteHandler: Events dispatched
deactivate EventDispatcher

CompleteHandler --> MediatR: Success
deactivate CompleteHandler
MediatR --> Scheduler: Success
deactivate MediatR

Scheduler --> Scheduler: Maintenance complete
deactivate Scheduler

@enduml
