@startuml Role Management Sequence Diagrams

' ============================================
' Create Role Flow
' ============================================
@startuml Create Role
title Create Role Flow

actor Admin
participant "API Controller" as API
participant "MediatR" as MediatR
participant "CreateRoleCommandHandler" as Handler
participant "IRoleRepository" as Repo
participant "Role Aggregate" as Role
participant "UnitOfWork" as UOW
participant "Event Dispatcher" as Events
database "Database" as DB

Admin -> API: POST /api/roles\n{RoleName, Description, Permissions}
activate API

API -> MediatR: Send(CreateRoleCommand)
activate MediatR

MediatR -> Handler: Handle(CreateRoleCommand)
activate Handler

Handler -> Handler: Validate request\n(permissions, role name)

Handler -> Repo: GetByNameAsync(roleName, accountId)
activate Repo
Repo -> DB: Query role by name
DB --> Repo: null (not exists)
Repo --> Handler: null
deactivate Repo

Handler -> Role: Create(roleName, description,\naccountId, createdBy, permissions)
activate Role

Role -> Role: Validate invariants\n(name not empty, etc.)
Role -> Role: Generate RoleId
Role -> Role: Create Permission objects

Role -> Role: AddDomainEvent(\nRoleCreatedDomainEvent)

Role --> Handler: Role instance
deactivate Role

Handler -> Repo: AddAsync(role)
activate Repo
Repo --> Handler: void
deactivate Repo

Handler -> UOW: SaveChangesAsync()
activate UOW

UOW -> DB: Begin Transaction
UOW -> DB: INSERT INTO Roles
UOW -> DB: INSERT INTO Permissions
UOW -> DB: Commit Transaction

UOW -> Events: Dispatch Domain Events
activate Events
Events -> Events: Publish(RoleCreatedDomainEvent)
Events --> UOW: void
deactivate Events

UOW --> Handler: void
deactivate UOW

Handler --> MediatR: CreateRoleResponse\n(RoleId, RoleName, CreatedAt)
deactivate Handler

MediatR --> API: CreateRoleResponse
deactivate MediatR

API --> Admin: 201 Created\n{RoleId, RoleName, CreatedAt}
deactivate API

@enduml

' ============================================
' Update Permissions Flow
' ============================================
@startuml Update Permissions
title Update Role Permissions Flow

actor Admin
participant "API Controller" as API
participant "MediatR" as MediatR
participant "UpdateRolePermissionsCommandHandler" as Handler
participant "IRoleRepository" as Repo
participant "Role Aggregate" as Role
participant "UnitOfWork" as UOW
participant "Event Dispatcher" as Events
database "Database" as DB

Admin -> API: PUT /api/roles/{roleId}/permissions\n{AddedPermissions, RemovedPermissions}
activate API

API -> MediatR: Send(UpdateRolePermissionsCommand)
activate MediatR

MediatR -> Handler: Handle(UpdateRolePermissionsCommand)
activate Handler

Handler -> Repo: GetByIdAsync(roleId)
activate Repo
Repo -> DB: Query role with permissions
DB --> Repo: Role data
Repo --> Handler: Role aggregate
deactivate Repo

Handler -> Handler: Authorize user\n(check permissions)

Handler -> Role: UpdatePermissions(\naddedPermissions,\nremovedPermissions,\nupdatedBy)
activate Role

Role -> Role: Validate permissions format\n(Resource:Action)

Role -> Role: Remove old permissions
Role -> Role: Add new permissions
Role -> Role: Update timestamp

Role -> Role: AddDomainEvent(\nRolePermissionsUpdatedDomainEvent)

Role --> Handler: void
deactivate Role

Handler -> Repo: UpdateAsync(role)
activate Repo
Repo --> Handler: void
deactivate Repo

Handler -> UOW: SaveChangesAsync()
activate UOW

UOW -> DB: Begin Transaction
UOW -> DB: DELETE FROM Permissions\n(removed)
UOW -> DB: INSERT INTO Permissions\n(added)
UOW -> DB: UPDATE Roles\n(UpdatedAt)
UOW -> DB: Commit Transaction

UOW -> Events: Dispatch Domain Events
activate Events
Events -> Events: Publish(\nRolePermissionsUpdatedDomainEvent)
Events --> UOW: void
deactivate Events

UOW --> Handler: void
deactivate UOW

Handler --> MediatR: Unit
deactivate Handler

MediatR --> API: Unit
deactivate MediatR

API --> Admin: 200 OK
deactivate API

@enduml

' ============================================
' Assign Role to User Flow
' ============================================
@startuml Assign Role to User
title Assign Role to User Flow

actor Admin
participant "API Controller" as API
participant "MediatR" as MediatR
participant "AssignRoleToUserCommandHandler" as Handler
participant "IRoleRepository" as Repo
participant "Role Aggregate" as Role
participant "UserRole Entity" as UserRole
participant "UnitOfWork" as UOW
participant "Event Dispatcher" as Events
database "Database" as DB

Admin -> API: POST /api/roles/{roleId}/users/{userId}
activate API

API -> MediatR: Send(AssignRoleToUserCommand)
activate MediatR

MediatR -> Handler: Handle(AssignRoleToUserCommand)
activate Handler

Handler -> Handler: Authorize user

Handler -> Repo: GetByIdAsync(roleId)
activate Repo
Repo -> DB: Query role with user roles
DB --> Repo: Role data
Repo --> Handler: Role aggregate
deactivate Repo

Handler -> Handler: Verify user exists

Handler -> Role: AssignToUser(userId, assignedBy)
activate Role

Role -> Role: Check if already assigned\n(user not in UserRoles)

alt Role already assigned
    Role --> Handler: throw InvalidOperationException
    Handler --> API: 409 Conflict
else Not assigned
    Role -> UserRole: Create(userId, roleId, assignedBy)
    activate UserRole
    UserRole -> UserRole: Generate UserRoleId
    UserRole -> UserRole: Set AssignedAt
    UserRole --> Role: UserRole instance
    deactivate UserRole

    Role -> Role: UserRoles.Add(userRole)
    Role -> Role: Update timestamp

    Role -> Role: AddDomainEvent(\nRoleAssignedToUserDomainEvent)

    Role --> Handler: void
end
deactivate Role

Handler -> Repo: UpdateAsync(role)
activate Repo
Repo --> Handler: void
deactivate Repo

Handler -> UOW: SaveChangesAsync()
activate UOW

UOW -> DB: Begin Transaction
UOW -> DB: INSERT INTO UserRoles
UOW -> DB: UPDATE Roles\n(UpdatedAt)
UOW -> DB: Commit Transaction

UOW -> Events: Dispatch Domain Events
activate Events
Events -> Events: Publish(\nRoleAssignedToUserDomainEvent)
Events --> UOW: void
deactivate Events

UOW --> Handler: void
deactivate UOW

Handler --> MediatR: AssignRoleResponse\n(UserRoleId, AssignedAt)
deactivate Handler

MediatR --> API: AssignRoleResponse
deactivate MediatR

API --> Admin: 200 OK\n{UserRoleId, AssignedAt}
deactivate API

@enduml

' ============================================
' Revoke Role from User Flow
' ============================================
@startuml Revoke Role from User
title Revoke Role from User Flow

actor Admin
participant "API Controller" as API
participant "MediatR" as MediatR
participant "RevokeRoleFromUserCommandHandler" as Handler
participant "IRoleRepository" as Repo
participant "Role Aggregate" as Role
participant "UserRole Entity" as UserRole
participant "UnitOfWork" as UOW
participant "Event Dispatcher" as Events
database "Database" as DB

Admin -> API: DELETE /api/roles/{roleId}/users/{userId}\n{Reason}
activate API

API -> MediatR: Send(RevokeRoleFromUserCommand)
activate MediatR

MediatR -> Handler: Handle(RevokeRoleFromUserCommand)
activate Handler

Handler -> Handler: Authorize user

Handler -> Repo: GetByIdAsync(roleId)
activate Repo
Repo -> DB: Query role with user roles
DB --> Repo: Role data
Repo --> Handler: Role aggregate
deactivate Repo

Handler -> Role: RevokeFromUser(userId, revokedBy, reason)
activate Role

Role -> Role: Find UserRole for user\n(not already revoked)

alt UserRole not found
    Role --> Handler: throw InvalidOperationException
    Handler --> API: 404 Not Found
else UserRole found
    Role -> UserRole: Revoke(revokedBy, reason)
    activate UserRole

    UserRole -> UserRole: Set IsRevoked = true
    UserRole -> UserRole: Set RevokedBy
    UserRole -> UserRole: Set RevokedAt
    UserRole -> UserRole: Set RevokedReason

    UserRole --> Role: void
    deactivate UserRole

    Role -> Role: Update timestamp

    Role -> Role: AddDomainEvent(\nRoleRevokedFromUserDomainEvent)

    Role --> Handler: void
end
deactivate Role

Handler -> Repo: UpdateAsync(role)
activate Repo
Repo --> Handler: void
deactivate Repo

Handler -> UOW: SaveChangesAsync()
activate UOW

UOW -> DB: Begin Transaction
UOW -> DB: UPDATE UserRoles\n(IsRevoked, RevokedBy, etc.)
UOW -> DB: UPDATE Roles\n(UpdatedAt)
UOW -> DB: Commit Transaction

UOW -> Events: Dispatch Domain Events
activate Events
Events -> Events: Publish(\nRoleRevokedFromUserDomainEvent)
Events --> UOW: void
deactivate Events

UOW --> Handler: void
deactivate UOW

Handler --> MediatR: Unit
deactivate Handler

MediatR --> API: Unit
deactivate MediatR

API --> Admin: 200 OK
deactivate API

@enduml

' ============================================
' Delete Role Flow
' ============================================
@startuml Delete Role
title Delete Role Flow

actor Admin
participant "API Controller" as API
participant "MediatR" as MediatR
participant "DeleteRoleCommandHandler" as Handler
participant "IRoleRepository" as Repo
participant "Role Aggregate" as Role
participant "UnitOfWork" as UOW
participant "Event Dispatcher" as Events
database "Database" as DB

Admin -> API: DELETE /api/roles/{roleId}
activate API

API -> MediatR: Send(DeleteRoleCommand)
activate MediatR

MediatR -> Handler: Handle(DeleteRoleCommand)
activate Handler

Handler -> Handler: Authorize user

Handler -> Repo: GetByIdAsync(roleId)
activate Repo
Repo -> DB: Query role with user roles
DB --> Repo: Role data
Repo --> Handler: Role aggregate
deactivate Repo

Handler -> Role: Delete(deletedBy)
activate Role

alt Is system role
    Role --> Handler: throw InvalidOperationException
    Handler --> API: 400 Bad Request\n"Cannot delete system role"
else Not system role
    Role -> Role: Count active user assignments

    Role -> Role: Set IsDeleted = true
    Role -> Role: Set DeletedAt

    Role -> Role: AddDomainEvent(\nRoleDeletedDomainEvent(\naffectedUserCount))

    Role --> Handler: void
end
deactivate Role

Handler -> Repo: UpdateAsync(role)\n(soft delete)
activate Repo
Repo --> Handler: void
deactivate Repo

Handler -> UOW: SaveChangesAsync()
activate UOW

UOW -> DB: Begin Transaction
UOW -> DB: UPDATE Roles\n(IsDeleted, DeletedAt)
UOW -> DB: UPDATE UserRoles\n(revoke all active assignments)
UOW -> DB: Commit Transaction

UOW -> Events: Dispatch Domain Events
activate Events
Events -> Events: Publish(\nRoleDeletedDomainEvent)
Events --> UOW: void
deactivate Events

UOW --> Handler: void
deactivate UOW

Handler --> MediatR: Unit
deactivate Handler

MediatR --> API: Unit
deactivate MediatR

API --> Admin: 204 No Content
deactivate API

@enduml

' ============================================
' Check User Permission Flow
' ============================================
@startuml Check User Permission
title Check User Permission Flow (RBAC)

actor "API Request" as Client
participant "Authorization\nMiddleware" as Middleware
participant "IRoleAuthorizationService" as AuthService
participant "IRoleRepository" as Repo
database "Database" as DB

Client -> Middleware: HTTP Request\n[Authorize("Content:Create")]
activate Middleware

Middleware -> Middleware: Extract UserId from JWT

Middleware -> AuthService: UserHasPermissionAsync(\nuserId, "Content:Create")
activate AuthService

AuthService -> Repo: GetUserRolesAsync(userId,\nincludeRevoked: false)
activate Repo

Repo -> DB: SELECT UserRoles\nJOIN Roles\nWHERE UserId = @userId\nAND IsRevoked = false\nAND IsDeleted = false
activate DB
DB --> Repo: User's active roles
deactivate DB
Repo --> AuthService: List<Role>
deactivate Repo

AuthService -> AuthService: foreach role in roles

loop For each role
    AuthService -> AuthService: Get role permissions
    AuthService -> AuthService: Check permission match\n(Resource:Action)

    alt Permission matches
        AuthService --> Middleware: true
    end
end

alt No matching permission
    AuthService --> Middleware: false
    Middleware --> Client: 403 Forbidden
else Has permission
    Middleware -> Client: Continue to controller
end

deactivate AuthService
deactivate Middleware

@enduml

@enduml
