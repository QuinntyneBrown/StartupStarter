@startuml Role Management Domain Model

!define AGGREGATE_ROOT_COLOR #FFE4B5
!define ENTITY_COLOR #E0FFFF
!define VALUE_OBJECT_COLOR #E6E6FA
!define ENUM_COLOR #FFE4E1

skinparam class {
    BackgroundColor<<AggregateRoot>> AGGREGATE_ROOT_COLOR
    BackgroundColor<<Entity>> ENTITY_COLOR
    BackgroundColor<<ValueObject>> VALUE_OBJECT_COLOR
    BackgroundColor<<Enum>> ENUM_COLOR
    BorderColor Black
    ArrowColor Black
}

package "Role Management Domain" {

    class Role <<AggregateRoot>> {
        + RoleId: Guid
        + RoleName: string
        + Description: string
        + AccountId: Guid
        + IsSystemRole: bool
        + CreatedBy: Guid
        + CreatedAt: DateTime
        + UpdatedAt: DateTime?
        + DeletedAt: DateTime?
        + IsDeleted: bool
        --
        + {static} Create(): Role
        + Update(): void
        + UpdatePermissions(): void
        + AssignToUser(): void
        + RevokeFromUser(): void
        + Delete(): void
        + HasPermission(): bool
        + GetAllPermissions(): List<string>
    }

    class UserRole <<Entity>> {
        + UserRoleId: Guid
        + UserId: Guid
        + RoleId: Guid
        + AssignedBy: Guid
        + AssignedAt: DateTime
        + IsRevoked: bool
        + RevokedBy: Guid?
        + RevokedAt: DateTime?
        + RevokedReason: string
        --
        + {static} Create(): UserRole
        + Revoke(): void
    }

    class Permission <<ValueObject>> {
        + PermissionId: Guid
        + RoleId: Guid
        + PermissionName: string
        + Resource: string
        + Action: string
        + CreatedAt: DateTime
        --
        + {static} Create(): Permission
        + Matches(): bool
        + Equals(): bool
        + GetHashCode(): int
    }

    class User <<Entity>> {
        + UserId: Guid
        + UserName: string
        + Email: string
        + AccountId: Guid
    }

    class Account <<AggregateRoot>> {
        + AccountId: Guid
        + AccountName: string
    }

    abstract class AggregateRoot {
        # _domainEvents: List<DomainEvent>
        + DomainEvents: IReadOnlyCollection<DomainEvent>
        --
        # AddDomainEvent(): void
        + ClearDomainEvents(): void
    }

    abstract class DomainEvent {
        + EventId: Guid
        + OccurredAt: DateTime
    }
}

package "Domain Events" {
    class RoleCreatedDomainEvent {
        + RoleId: Guid
        + RoleName: string
        + Description: string
        + AccountId: Guid
        + Permissions: List<string>
        + CreatedBy: Guid
    }

    class RoleUpdatedDomainEvent {
        + RoleId: Guid
        + RoleName: string
        + AccountId: Guid
        + UpdatedBy: Guid
        + UpdatedFields: Dictionary
        + PreviousValues: Dictionary
    }

    class RoleDeletedDomainEvent {
        + RoleId: Guid
        + RoleName: string
        + AccountId: Guid
        + DeletedBy: Guid
        + AffectedUserCount: int
    }

    class RoleAssignedToUserDomainEvent {
        + RoleId: Guid
        + RoleName: string
        + UserId: Guid
        + AccountId: Guid
        + AssignedBy: Guid
    }

    class RoleRevokedFromUserDomainEvent {
        + RoleId: Guid
        + RoleName: string
        + UserId: Guid
        + AccountId: Guid
        + RevokedBy: Guid
        + Reason: string
    }

    class RolePermissionsUpdatedDomainEvent {
        + RoleId: Guid
        + RoleName: string
        + AccountId: Guid
        + AddedPermissions: List<string>
        + RemovedPermissions: List<string>
        + UpdatedBy: Guid
    }
}

' Relationships
Role "1" *-- "0..*" Permission : contains >
Role "1" *-- "0..*" UserRole : has >
Role --|> AggregateRoot
Account --|> AggregateRoot

UserRole "*" --> "1" User : assigned to >
UserRole "*" --> "1" Role : references >

Role "*" --> "1" Account : belongs to >
Role "*" --> "1" User : created by >

' Domain Events
RoleCreatedDomainEvent --|> DomainEvent
RoleUpdatedDomainEvent --|> DomainEvent
RoleDeletedDomainEvent --|> DomainEvent
RoleAssignedToUserDomainEvent --|> DomainEvent
RoleRevokedFromUserDomainEvent --|> DomainEvent
RolePermissionsUpdatedDomainEvent --|> DomainEvent

note right of Role
  **Aggregate Root**
  - Enforces role invariants
  - Manages permissions
  - Controls user assignments
  - Prevents deletion of system roles
  - Raises domain events
end note

note right of Permission
  **Value Object**
  - Format: "Resource:Action"
  - Immutable
  - Examples:
    * Content:Create
    * Content:Read
    * User:Update
    * User:Delete
    * *:* (wildcard)
end note

note bottom of UserRole
  **Entity**
  - Links users to roles
  - Tracks assignment history
  - Supports revocation
  - Maintains audit trail
end note

@enduml
