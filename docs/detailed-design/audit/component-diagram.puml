@startuml Audit Management Component Architecture

!define CONTROLLER_COLOR #FFF9C4
!define SERVICE_COLOR #F3E5F5
!define REPOSITORY_COLOR #C8E6C9
!define EXTERNAL_COLOR #CFD8DC

title Audit Management - Component Architecture with MediatR

package "Presentation Layer" {
    component [Angular 21 UI] as UI <<Angular>>
    component [Audit Dashboard] as Dashboard <<Angular Component>>
    component [Export Manager] as ExportUI <<Angular Component>>
    component [SignalR Client] as SignalRClient <<Angular>>
}

package "API Layer" {
    component [API Gateway] as Gateway <<ASP.NET Core>>
    component [JWT Middleware] as JWT <<Middleware>>
    component [Audit Interceptor] as Interceptor <<AOP Middleware>>
    component [AuditController] as AuditCtrl <<Controller>>
    component [ExportController] as ExportCtrl <<Controller>>
    component [ComplianceController] as ComplianceCtrl <<Controller>>
    component [AuditHub] as Hub <<SignalR Hub>>
}

package "Application Layer" {
    component [MediatR] as Mediator <<MediatR>>

    package "Commands" {
        component [CreateAuditLogHandler] as CreateAuditHandler <<IRequestHandler>>
        component [RequestExportHandler] as RequestExportHandler <<IRequestHandler>>
        component [ProcessExportHandler] as ProcessExportHandler <<IRequestHandler>>
        component [ApplyRetentionHandler] as RetentionHandler <<IRequestHandler>>
        component [CreateRetentionPolicyHandler] as CreatePolicyHandler <<IRequestHandler>>
    }

    package "Queries" {
        component [GetAuditLogByIdHandler] as GetByIdHandler <<IRequestHandler>>
        component [GetAuditLogsByEntityHandler] as GetByEntityHandler <<IRequestHandler>>
        component [GetAuditLogsByAccountHandler] as GetByAccountHandler <<IRequestHandler>>
        component [GetExportByIdHandler] as GetExportHandler <<IRequestHandler>>
        component [GetRetentionPoliciesHandler] as GetPoliciesHandler <<IRequestHandler>>
    }

    component [FluentValidation Pipeline] as Validation <<Behavior>>
    component [AutoMapper] as Mapper <<Mapping>>
    component [Domain Event Dispatcher] as EventDispatcher <<Service>>
    component [Audit Export Service] as ExportService <<Service>>
    component [Compliance Service] as ComplianceService <<Service>>
}

package "Domain Layer" {
    component [AuditLog Aggregate] as AuditAgg <<Aggregate Root>>
    component [AuditExport Entity] as ExportEntity <<Entity>>
    component [AuditRetentionPolicy Entity] as PolicyEntity <<Entity>>
    component [Domain Events] as DomainEvents <<Events>>
    component [IAuditLogRepository] as IAuditRepo <<Interface>>
    component [IAuditExportRepository] as IExportRepo <<Interface>>
    component [IAuditRetentionPolicyRepository] as IPolicyRepo <<Interface>>
}

package "Infrastructure Layer" {
    component [AuditLogRepository] as AuditRepo <<Repository>>
    component [AuditExportRepository] as ExportRepo <<Repository>>
    component [AuditRetentionPolicyRepository] as PolicyRepo <<Repository>>
    component [ApplicationDbContext] as DbContext <<EF Core>>
    component [SignalR Service] as SignalRService <<Service>>
    component [Service Bus Client] as ServiceBusClient <<Azure>>
    component [Background Job Scheduler] as JobScheduler <<Hangfire/Azure Functions>>
    component [Blob Storage Client] as BlobClient <<Azure>>
    component [SIEM Integration] as SIEM <<Service>>
}

package "External Services" {
    database "Azure SQL Database" as DB {
        [AuditLogs]
        [AuditExports]
        [AuditRetentionPolicies]
        [ComplianceMetadata]
    }
    queue "Azure Service Bus" as ServiceBus
    cloud "Azure Blob Storage" as BlobStorage
    cloud "Azure Monitor" as Monitor
    cloud "Application Insights" as AppInsights
    cloud "External SIEM" as ExternalSIEM
}

' Presentation to API connections
UI --> Dashboard : Displays
UI --> ExportUI : Manages
SignalRClient --> Hub : WebSocket
Dashboard --> Gateway : HTTPS/REST
ExportUI --> Gateway : HTTPS/REST
Gateway --> JWT : Authenticate
Interceptor --> JWT : After Auth
JWT --> AuditCtrl : Authorized Request
JWT --> ExportCtrl : Authorized Request
JWT --> ComplianceCtrl : Authorized Request

' Audit Interception (AOP)
Interceptor --> Mediator : Send(CreateAuditLogCommand)
note right of Interceptor
  Automatic audit capture
  for all tracked operations
end note

' API to Application connections
AuditCtrl --> Mediator : Send(Commands/Queries)
ExportCtrl --> Mediator : Send(RequestExportCommand)
ComplianceCtrl --> Mediator : Send(ComplianceQueries)

' MediatR Pipeline
Mediator --> Validation : Pipeline Behavior
Validation --> CreateAuditHandler : Validated Command
Validation --> RequestExportHandler : Validated Command
Validation --> ProcessExportHandler : Validated Command
Validation --> RetentionHandler : Validated Command
Validation --> CreatePolicyHandler : Validated Command

Mediator --> GetByIdHandler : Query
Mediator --> GetByEntityHandler : Query
Mediator --> GetByAccountHandler : Query
Mediator --> GetExportHandler : Query
Mediator --> GetPoliciesHandler : Query

' Handlers to Domain
CreateAuditHandler --> AuditAgg : Create()
RequestExportHandler --> ExportEntity : Create()
ProcessExportHandler --> ExportEntity : Complete()
RetentionHandler --> PolicyEntity : Uses
CreatePolicyHandler --> PolicyEntity : Create()

AuditAgg --> DomainEvents : Raises
ExportEntity --> DomainEvents : Raises
PolicyEntity --> DomainEvents : Raises

' Handlers to Repositories
CreateAuditHandler --> IAuditRepo : AddAsync()
RequestExportHandler --> IExportRepo : AddAsync()
ProcessExportHandler --> IExportRepo : UpdateAsync()
ProcessExportHandler --> IAuditRepo : GetForExportAsync()
RetentionHandler --> IPolicyRepo : GetAllActiveAsync()
RetentionHandler --> IAuditRepo : DeleteExpiredLogsAsync()
GetByIdHandler --> IAuditRepo : GetByIdAsync()
GetByEntityHandler --> IAuditRepo : GetPagedByEntityAsync()
GetByAccountHandler --> IAuditRepo : GetPagedByAccountAsync()
GetExportHandler --> IExportRepo : GetByIdAsync()
GetPoliciesHandler --> IPolicyRepo : GetActiveByAccountAsync()

' Repository Implementation
IAuditRepo <|.. AuditRepo : implements
IExportRepo <|.. ExportRepo : implements
IPolicyRepo <|.. PolicyRepo : implements
AuditRepo --> DbContext : Uses
ExportRepo --> DbContext : Uses
PolicyRepo --> DbContext : Uses
DbContext --> DB : EF Core

' Services
ProcessExportHandler --> ExportService : ExportToFormat()
CreateAuditHandler --> ComplianceService : ValidateCompliance()
RetentionHandler --> ComplianceService : ValidateRetentionCompliance()
ExportService --> BlobClient : UploadFile()

' Event Handling
CreateAuditHandler --> EventDispatcher : DispatchDomainEvents()
RequestExportHandler --> EventDispatcher : DispatchDomainEvents()
RetentionHandler --> EventDispatcher : DispatchDomainEvents()

EventDispatcher --> ServiceBusClient : Publish Integration Events
EventDispatcher --> SignalRService : Send Real-time Notifications
EventDispatcher --> SIEM : Send Security Events

' Background Jobs
JobScheduler --> ProcessExportHandler : Process Export (Async)
JobScheduler --> RetentionHandler : Apply Retention (Daily)
JobScheduler --> ExportRepo : Cleanup Expired Exports (Daily)

' Infrastructure to External
ServiceBusClient --> ServiceBus : Publish/Subscribe
SignalRService --> Hub : Notify Clients
BlobClient --> BlobStorage : Upload/Download Files
SIEM --> ExternalSIEM : Forward Security Events
DbContext --> Monitor : Performance Metrics
DbContext --> AppInsights : Telemetry

' Mapping
GetByIdHandler --> Mapper : Map to DTO
GetByEntityHandler --> Mapper : Map to DTO
GetByAccountHandler --> Mapper : Map to DTO
GetExportHandler --> Mapper : Map to DTO
GetPoliciesHandler --> Mapper : Map to DTO

note right of Mediator
  MediatR Pattern:
  1. Interceptor captures all operations
  2. Controllers send explicit commands/queries
  3. Pipeline behaviors (validation, logging)
  4. Handlers process requests
  5. Domain logic executed
  6. Events dispatched
end note

note right of AuditAgg
  Aggregate Root:
  - Immutable once created
  - Enforces compliance rules
  - Raises domain events
  - Supports GDPR/SOC2/HIPAA
end note

note bottom of EventDispatcher
  Event Flow:
  1. Domain events raised in aggregate
  2. Dispatcher publishes after SaveChanges
  3. Integration events to Service Bus
  4. Real-time notifications via SignalR
  5. Security events to SIEM
end note

note right of DB
  Database Schema:
  - AuditLogs (immutable, indexed)
  - AuditExports (export requests)
  - AuditRetentionPolicies (cleanup rules)
  - Partition by date for performance
  - Automatic archiving to blob storage
end note

note right of Interceptor
  AOP Audit Capture:
  - Intercepts all tracked operations
  - Extracts before/after state
  - Captures user context
  - Records IP, UserAgent, SessionId
  - Async processing (no performance impact)
end note

note bottom of ComplianceService
  Compliance Validation:
  - GDPR: Right to be forgotten, data portability
  - SOC2: Security event tracking, access logs
  - HIPAA: PHI access tracking, 6-year retention
  - Automatic compliance scoring
end note

note bottom of JobScheduler
  Background Jobs:
  1. Process Export (on-demand)
  2. Apply Retention Policy (daily 2:00 AM)
  3. Cleanup Expired Exports (daily)
  4. Send Compliance Reports (weekly)
  5. Archive Old Logs (monthly)
end note

note right of BlobStorage
  Blob Storage Structure:
  /exports/{accountId}/{exportId}.{format}
  /archives/{year}/{month}/{accountId}/

  Security:
  - SAS tokens for time-limited access
  - Encryption at rest
  - Automatic deletion after expiry
  - Access logging enabled
end note

@enduml
