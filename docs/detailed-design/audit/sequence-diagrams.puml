@startuml Audit Management Sequence Diagrams

!define FRONTEND_COLOR #E1F5FE
!define API_COLOR #FFF9C4
!define SERVICE_COLOR #F3E5F5
!define REPOSITORY_COLOR #C8E6C9
!define EVENT_COLOR #FFCCBC
!define DB_COLOR #CFD8DC

' ====================================================================
' Create Audit Log Flow
' ====================================================================
@startuml Create Audit Log
title Create Audit Log - Automatic Event Capture

participant "Domain Service" as DomainService SERVICE_COLOR
participant "Audit Interceptor" as Interceptor SERVICE_COLOR
participant "MediatR" as Mediator SERVICE_COLOR
participant "CreateAuditLogHandler" as Handler SERVICE_COLOR
participant "IAuditLogRepository" as Repo REPOSITORY_COLOR
participant "DbContext" as DB DB_COLOR
participant "IDomainEventDispatcher" as EventDispatcher EVENT_COLOR
participant "Compliance Service" as Compliance SERVICE_COLOR
participant "Azure Service Bus" as ServiceBus EVENT_COLOR

activate DomainService

DomainService -> DomainService : Execute Business Operation\n(e.g., Update User)
note right: Any tracked operation\nAutomatically captured

DomainService -> Interceptor : OnActionExecuted(context)
activate Interceptor
note right: AOP Interceptor captures:\n- EntityType, EntityId\n- Action performed\n- User context\n- Before/After state

Interceptor -> Interceptor : Extract Audit Context
note right: Get from HttpContext:\n- UserId\n- IPAddress\n- UserAgent\n- SessionId

Interceptor -> Mediator : Send(CreateAuditLogCommand)
activate Mediator

Mediator -> Handler : Handle(CreateAuditLogCommand)
activate Handler

Handler -> Handler : Validate Command
note right: Ensure required fields:\n- EntityType\n- EntityId\n- Action\n- PerformedBy

Handler -> Handler : AuditLog.Create()
note right: Create immutable audit log\nRaises AuditLogCreatedDomainEvent

Handler -> Compliance : ValidateCompliance(auditLog)
activate Compliance
note right: Check GDPR, SOC2, HIPAA\nrequirements based on\nentity type and account

Compliance --> Handler : ComplianceResult
deactivate Compliance

alt Non-Compliant Data
    Handler -> Handler : auditLog.MarkAsNonCompliant()
    note right: Flag for review\nAlert compliance officer
end

Handler -> Handler : Calculate Retention Expiry
note right: Apply retention policy\nbased on entity type

Handler -> Repo : AddAsync(auditLog)
activate Repo
Repo -> DB : INSERT AuditLog
activate DB
DB --> Repo : Success
deactivate DB
Repo --> Handler : Success
deactivate Repo

Handler -> Repo : SaveChangesAsync()
activate Repo
Repo -> DB : COMMIT Transaction
activate DB
DB --> Repo : Success
deactivate DB
Repo --> Handler : Success
deactivate Repo

Handler -> EventDispatcher : DispatchAsync(domainEvents)
activate EventDispatcher
note right: Publish domain events\nfor audit analytics

EventDispatcher -> ServiceBus : Publish\nAuditLogCreatedEvent
activate ServiceBus
note right: Integration event for:\n- SIEM systems\n- Analytics pipeline\n- Compliance monitoring
ServiceBus --> EventDispatcher : Acknowledged
deactivate ServiceBus

EventDispatcher --> Handler : Complete
deactivate EventDispatcher

Handler --> Mediator : CreateAuditLogResponse
deactivate Handler

Mediator --> Interceptor : Response
deactivate Mediator

Interceptor --> DomainService : Audit Logged
deactivate Interceptor

deactivate DomainService

note over DB
  Audit logs are immutable
  Never updated, only created
  Retention policy applied automatically
end note

@enduml

' ====================================================================
' Request Export Flow
' ====================================================================
@startuml Request Export
title Request Audit Export - Compliance Report Generation

actor "Compliance Officer" as Officer FRONTEND_COLOR
participant "Angular UI" as UI FRONTEND_COLOR
participant "API Gateway" as Gateway API_COLOR
participant "Audit Controller" as Controller API_COLOR
participant "MediatR" as Mediator SERVICE_COLOR
participant "RequestExportHandler" as Handler SERVICE_COLOR
participant "IAuditExportRepository" as ExportRepo REPOSITORY_COLOR
participant "DbContext" as DB DB_COLOR
participant "Azure Service Bus" as ServiceBus EVENT_COLOR
participant "Background Job" as BackgroundJob EVENT_COLOR

Officer -> UI : Select Date Range\nApply Filters\nChoose Format
activate UI

UI -> Gateway : POST /api/audit/export\n{startDate, endDate, filters, format}
activate Gateway
note right: JWT Bearer Token\nRequires AuditExport permission

Gateway -> Controller : Route Request
activate Controller

Controller -> Controller : Validate Permissions
note right: Check user has\nAuditExport role claim

Controller -> Mediator : Send(RequestAuditExportCommand)
activate Mediator

Mediator -> Handler : Handle(RequestAuditExportCommand)
activate Handler

Handler -> Handler : Validate Command
note right: FluentValidation:\n- Date range valid\n- Max 90 days\n- Valid format

Handler -> Handler : Check Rate Limits
note right: Max 10 exports per account\nper day (prevent abuse)

alt Rate Limit Exceeded
    Handler --> Mediator : RateLimitException
    Mediator --> Controller : 429 Too Many Requests
    Controller --> UI : Rate Limit Error
else Within Limits
    Handler -> Handler : AuditExport.Create()
    note right: Status = Requested\nCreate export request

    Handler -> ExportRepo : AddAsync(auditExport)
    activate ExportRepo
    ExportRepo -> DB : INSERT AuditExport
    activate DB
    DB --> ExportRepo : Success
    deactivate DB
    ExportRepo --> Handler : Success
    deactivate ExportRepo

    Handler -> ExportRepo : SaveChangesAsync()
    activate ExportRepo
    ExportRepo -> DB : COMMIT
    activate DB
    DB --> ExportRepo : Success
    deactivate DB
    ExportRepo --> Handler : Success
    deactivate ExportRepo

    Handler -> ServiceBus : Publish\nAuditExportRequestedEvent
    activate ServiceBus
    note right: Queue message for\nbackground processing
    ServiceBus --> Handler : Acknowledged
    deactivate ServiceBus

    Handler -> BackgroundJob : Queue ProcessExportJob(exportId)
    activate BackgroundJob
    note right: Hangfire/Azure Functions\nProcesses export async
    BackgroundJob --> Handler : Job Queued
    deactivate BackgroundJob

    Handler --> Mediator : RequestAuditExportResponse
    Mediator --> Controller : Response
    Controller --> Gateway : 202 Accepted\n{exportId, status: Requested}
    Gateway --> UI : Export Requested
    UI --> Officer : Export queued for processing\nYou'll be notified when ready
end

deactivate Handler
deactivate Mediator
deactivate Controller
deactivate Gateway
deactivate UI

note over BackgroundJob
  Background processing handles:
  1. Retrieve audit logs
  2. Apply filters
  3. Generate file (CSV/JSON/PDF/Excel)
  4. Upload to secure storage
  5. Update export status
  6. Notify requester
end note

@enduml

' ====================================================================
' Process Export Flow
' ====================================================================
@startuml Process Export
title Process Audit Export - Background Job Execution

participant "Background Job" as BackgroundJob EVENT_COLOR
participant "MediatR" as Mediator SERVICE_COLOR
participant "ProcessExportHandler" as Handler SERVICE_COLOR
participant "IAuditExportRepository" as ExportRepo REPOSITORY_COLOR
participant "IAuditLogRepository" as AuditRepo REPOSITORY_COLOR
participant "IAuditExportService" as ExportService SERVICE_COLOR
participant "DbContext" as DB DB_COLOR
participant "Azure Blob Storage" as BlobStorage DB_COLOR
participant "SignalR Hub" as SignalR EVENT_COLOR
participant "Email Service" as Email EVENT_COLOR

BackgroundJob -> Mediator : Send(ProcessAuditExportCommand)
activate BackgroundJob
activate Mediator

Mediator -> Handler : Handle(ProcessAuditExportCommand)
activate Handler

Handler -> ExportRepo : GetByIdAsync(exportId)
activate ExportRepo
ExportRepo -> DB : SELECT AuditExport
activate DB
DB --> ExportRepo : AuditExport
deactivate DB
ExportRepo --> Handler : AuditExport
deactivate ExportRepo

Handler -> Handler : Validate Export Status
note right: Must be Requested\nNot already processed

alt Already Processed
    Handler --> Mediator : InvalidOperationException
    Mediator --> BackgroundJob : Skip Processing
else Status is Requested
    Handler -> Handler : export.MarkAsProcessing()
    note right: Set Status = Processing

    Handler -> ExportRepo : UpdateAsync(export)
    activate ExportRepo
    ExportRepo -> DB : UPDATE AuditExport\nSET Status = Processing
    activate DB
    DB --> ExportRepo : Success
    deactivate DB
    ExportRepo --> Handler : Success
    deactivate ExportRepo

    Handler -> AuditRepo : GetForExportAsync(filters)
    activate AuditRepo
    note right: Retrieve audit logs:\n- Date range filter\n- Account filter\n- Action filter\n- Severity filter

    AuditRepo -> DB : SELECT AuditLog\nWHERE conditions
    activate DB
    DB --> AuditRepo : List<AuditLog>
    deactivate DB
    AuditRepo --> Handler : List<AuditLog>
    deactivate AuditRepo

    Handler -> Handler : Check Record Count
    note right: Max 100,000 records\nper export (prevent memory issues)

    alt Too Many Records
        Handler -> Handler : export.Fail("Too many records")
        Handler -> ExportRepo : UpdateAsync(export)
        Handler --> Mediator : Error Response
    else Within Limits
        Handler -> ExportService : ExportToFormat(logs, format)
        activate ExportService
        note right: Generate file based on format:\n- CSV: comma-separated\n- JSON: structured data\n- PDF: formatted report\n- Excel: spreadsheet

        ExportService -> ExportService : Generate File
        note right: Create temporary file\nApply formatting\nInclude metadata

        ExportService --> Handler : filePath
        deactivate ExportService

        Handler -> ExportService : UploadToStorageAsync(filePath)
        activate ExportService

        ExportService -> BlobStorage : Upload File
        activate BlobStorage
        note right: Azure Blob Storage\nSecure container\nSAS token for access
        BlobStorage --> ExportService : FileLocation (URL)
        deactivate BlobStorage

        ExportService --> Handler : fileLocation
        deactivate ExportService

        Handler -> Handler : export.Complete(recordCount, fileLocation)
        note right: Set Status = Completed\nStore file location\nSet expiry date (30 days)

        Handler -> ExportRepo : UpdateAsync(export)
        activate ExportRepo
        ExportRepo -> DB : UPDATE AuditExport
        activate DB
        DB --> ExportRepo : Success
        deactivate DB
        ExportRepo --> Handler : Success
        deactivate ExportRepo

        Handler -> SignalR : NotifyUser(requestedBy, exportId)
        activate SignalR
        note right: Real-time notification\nto requester
        SignalR --> Handler : Notified
        deactivate SignalR

        Handler -> Email : SendExportReadyEmail(requester)
        activate Email
        note right: Email with download link\nExpiry reminder
        Email --> Handler : Email Sent
        deactivate Email

        Handler --> Mediator : Success
    end
end

deactivate Handler

Mediator --> BackgroundJob : Processing Complete
deactivate Mediator
deactivate BackgroundJob

note over BlobStorage
  Export files are:
  - Encrypted at rest
  - Require SAS token to access
  - Automatically deleted after 30 days
  - Access logged for compliance
end note

@enduml

' ====================================================================
' Apply Retention Policy Flow
' ====================================================================
@startuml Apply Retention Policy
title Apply Retention Policy - Automated Cleanup

participant "Scheduled Job" as ScheduledJob EVENT_COLOR
participant "MediatR" as Mediator SERVICE_COLOR
participant "ApplyRetentionHandler" as Handler SERVICE_COLOR
participant "IAuditRetentionPolicyRepository" as PolicyRepo REPOSITORY_COLOR
participant "IAuditLogRepository" as AuditRepo REPOSITORY_COLOR
participant "DbContext" as DB DB_COLOR
participant "IDomainEventDispatcher" as EventDispatcher EVENT_COLOR
participant "Azure Service Bus" as ServiceBus EVENT_COLOR
participant "Compliance Service" as Compliance SERVICE_COLOR

note over ScheduledJob
  Runs daily at 2:00 AM UTC
  Hangfire recurring job or
  Azure Functions timer trigger
end note

ScheduledJob -> Mediator : Send(ApplyRetentionPolicyCommand)
activate ScheduledJob
activate Mediator

Mediator -> Handler : Handle(ApplyRetentionPolicyCommand)
activate Handler

Handler -> PolicyRepo : GetAllActiveAsync()
activate PolicyRepo
note right: Retrieve all active\nretention policies

PolicyRepo -> DB : SELECT AuditRetentionPolicy\nWHERE IsActive = true
activate DB
DB --> PolicyRepo : List<AuditRetentionPolicy>
deactivate DB
PolicyRepo --> Handler : List<AuditRetentionPolicy>
deactivate PolicyRepo

Handler -> Handler : Group Policies by Account
note right: Process global policies first\nThen account-specific

loop For Each Policy
    Handler -> Handler : Calculate Cutoff Date
    note right: cutoffDate = Today - RetentionDays

    Handler -> Compliance : ValidateRetentionCompliance(policy)
    activate Compliance
    note right: Ensure deletion complies with:\n- GDPR (30 days minimum)\n- SOC2 (90 days for security events)\n- HIPAA (6 years for healthcare)

    Compliance --> Handler : ComplianceValidation
    deactivate Compliance

    alt Non-Compliant Deletion
        Handler -> Handler : Skip Policy\nLog Warning
        note right: Alert admin about\ninvalid retention period
    else Compliant
        Handler -> AuditRepo : DeleteExpiredLogsAsync(cutoffDate, policy)
        activate AuditRepo
        note right: Delete audit logs WHERE:\n- Timestamp < cutoffDate\n- EntityType = policy.EntityType\n- AccountId = policy.AccountId (if set)

        AuditRepo -> DB : BEGIN TRANSACTION
        activate DB

        AuditRepo -> DB : DELETE FROM AuditLog\nWHERE conditions
        note right: Soft delete or hard delete\nbased on compliance requirements

        DB --> AuditRepo : deletedCount

        AuditRepo -> DB : COMMIT TRANSACTION
        DB --> AuditRepo : Success
        deactivate DB

        AuditRepo --> Handler : deletedCount
        deactivate AuditRepo

        Handler -> Handler : Track Deletion Metrics
        note right: Log:\n- Policy applied\n- Records deleted\n- Oldest date retained

        alt Records Deleted > 0
            Handler -> Handler : Create RetentionPolicyApplied Event
            note right: Raise domain event for\naudit of audit deletions

            Handler -> EventDispatcher : DispatchAsync(domainEvent)
            activate EventDispatcher

            EventDispatcher -> ServiceBus : Publish\nAuditRetentionPolicyAppliedEvent
            activate ServiceBus
            note right: Integration event for:\n- Compliance reporting\n- Audit analytics\n- Admin notifications
            ServiceBus --> EventDispatcher : Acknowledged
            deactivate ServiceBus

            EventDispatcher --> Handler : Complete
            deactivate EventDispatcher
        end
    end
end

Handler -> Handler : Calculate Summary
note right: Total deleted records\nOldest date retained\nPolicies applied

Handler -> DB : Log Retention Job Execution
activate DB
note right: Audit the retention process\nitself for compliance
DB --> Handler : Logged
deactivate DB

Handler --> Mediator : ApplyRetentionPolicyResponse
deactivate Handler

Mediator --> ScheduledJob : Retention Complete
deactivate Mediator
deactivate ScheduledJob

note over DB
  Retention Policy Guidelines:
  - GDPR: Min 30 days, unless right to be forgotten
  - SOC2: Min 90 days for security-critical events
  - HIPAA: Min 6 years for healthcare-related data
  - Financial: Min 7 years for financial transactions

  Deletion is logged in a separate
  compliance audit table (immutable)
end note

note over ServiceBus
  Integration events enable:
  1. Compliance officer notifications
  2. Dashboard updates (storage savings)
  3. External SIEM integration
  4. Regulatory reporting
end note

@enduml

@enduml
