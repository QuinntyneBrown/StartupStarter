@startuml Authentication Domain Model
!theme plain
skinparam linetype ortho
skinparam groupInheritance 2

' Base Classes
abstract class AggregateRoot {
  - _domainEvents: List<DomainEvent>
  + DomainEvents: IReadOnlyCollection<DomainEvent>
  # AddDomainEvent(event: DomainEvent)
  + ClearDomainEvents()
}

abstract class DomainEvent {
  + EventId: Guid
  + OccurredAt: DateTime
}

' Aggregate Roots
class UserSession {
  + SessionId: Guid
  + UserId: Guid
  + AccountId: Guid
  + Email: string
  + IPAddress: string
  + UserAgent: string
  + LoginMethod: LoginMethod
  + CreatedAt: DateTime
  + ExpiresAt: DateTime?
  + LastActivityAt: DateTime?
  + IsActive: bool
  + IsMfaVerified: bool
  + RefreshToken: string?
  + RefreshTokenExpiresAt: DateTime?
  --
  + {static} Create(...): UserSession
  + UpdateActivity()
  + SetRefreshToken(token, duration)
  + CompleteMfaVerification()
  + Expire()
  + Logout(logoutType: LogoutType)
  + IsExpired(): bool
  + IsRefreshTokenValid(): bool
}

class PasswordResetToken {
  + TokenId: Guid
  + Email: string
  + TokenHash: string
  + IPAddress: string
  + CreatedAt: DateTime
  + ExpiresAt: DateTime
  + IsUsed: bool
  + UsedAt: DateTime?
  + UserId: Guid?
  --
  + {static} Create(...): PasswordResetToken
  + MarkAsUsed(userId, accountId)
  + IsValid(): bool
}

class MfaConfiguration {
  + MfaConfigId: Guid
  + UserId: Guid
  + AccountId: Guid
  + MfaMethod: MfaMethod
  + IsEnabled: bool
  + EncryptedSecret: string?
  + PhoneNumber: string?
  + EmailAddress: string?
  + EnabledAt: DateTime?
  + DisabledAt: DateTime?
  + EnabledBy: Guid?
  + DisabledBy: Guid?
  + BackupCodes: List<string>
  + FailedAttempts: int
  + LastVerifiedAt: DateTime?
  --
  + {static} Create(...): MfaConfiguration
  + Disable(disabledBy, reason)
  + GenerateBackupCodes(codes)
  + RecordFailedAttempt()
  + RecordSuccessfulVerification()
  + ResetFailedAttempts()
}

' Entities
class LoginAttempt {
  + AttemptId: Guid
  + Email: string
  + UserId: Guid?
  + IPAddress: string
  + UserAgent: string
  + LoginMethod: LoginMethod
  + IsSuccessful: bool
  + FailureReason: FailureReason?
  + AttemptedAt: DateTime
  --
  + {static} CreateSuccessful(...): LoginAttempt
  + {static} CreateFailed(...): LoginAttempt
}

class User {
  + UserId: Guid
  + Email: string
  + PasswordHash: string
  + AccountId: Guid
  + IsLocked: bool
  + IsActive: bool
}

class Account {
  + AccountId: Guid
  + Name: string
  + IsActive: bool
}

' Enumerations
enum LoginMethod {
  Password
  SSO
  OAuth
  MFA
}

enum FailureReason {
  InvalidCredentials
  AccountLocked
  AccountDisabled
  MFAFailed
}

enum LogoutType {
  Manual
  SessionExpired
  ForcedLogout
}

enum MfaMethod {
  SMS
  Email
  AuthenticatorApp
  HardwareToken
}

enum ResetMethod {
  Email
  AdminReset
  SecurityQuestions
}

' Domain Events
class LoginAttemptedDomainEvent {
  + UserId: Guid?
  + Email: string
  + IPAddress: string
  + UserAgent: string
  + LoginMethod: LoginMethod
}

class LoginSucceededDomainEvent {
  + UserId: Guid
  + Email: string
  + AccountId: Guid
  + IPAddress: string
  + UserAgent: string
  + LoginMethod: LoginMethod
  + SessionId: Guid
}

class LoginFailedDomainEvent {
  + Email: string
  + IPAddress: string
  + UserAgent: string
  + FailureReason: FailureReason
  + AttemptCount: int
}

class LogoutInitiatedDomainEvent {
  + UserId: Guid
  + AccountId: Guid
  + SessionId: Guid
  + LogoutType: LogoutType
}

class SessionExpiredDomainEvent {
  + UserId: Guid
  + AccountId: Guid
  + SessionId: Guid
  + SessionDuration: TimeSpan
}

class MfaEnabledDomainEvent {
  + UserId: Guid
  + AccountId: Guid
  + MfaMethod: MfaMethod
  + EnabledBy: Guid
}

class MfaDisabledDomainEvent {
  + UserId: Guid
  + AccountId: Guid
  + DisabledBy: Guid
  + Reason: string
}

class PasswordResetRequestedDomainEvent {
  + Email: string
  + IPAddress: string
  + TokenHash: string
}

class PasswordResetCompletedDomainEvent {
  + UserId: Guid
  + AccountId: Guid
  + ResetMethod: ResetMethod
}

' Relationships - Inheritance
UserSession --|> AggregateRoot
PasswordResetToken --|> AggregateRoot
MfaConfiguration --|> AggregateRoot

LoginAttemptedDomainEvent --|> DomainEvent
LoginSucceededDomainEvent --|> DomainEvent
LoginFailedDomainEvent --|> DomainEvent
LogoutInitiatedDomainEvent --|> DomainEvent
SessionExpiredDomainEvent --|> DomainEvent
MfaEnabledDomainEvent --|> DomainEvent
MfaDisabledDomainEvent --|> DomainEvent
PasswordResetRequestedDomainEvent --|> DomainEvent
PasswordResetCompletedDomainEvent --|> DomainEvent

' Relationships - Aggregates
UserSession "1" --> "1" User : belongs to
UserSession "1" --> "1" Account : associated with
UserSession --> LoginMethod : uses

PasswordResetToken "0..*" --> "0..1" User : for
PasswordResetToken --> ResetMethod : completed via

MfaConfiguration "0..1" --> "1" User : configured for
MfaConfiguration "1" --> "1" Account : associated with
MfaConfiguration --> MfaMethod : uses

LoginAttempt "0..*" --> "0..1" User : for
LoginAttempt --> LoginMethod : attempted via
LoginAttempt --> FailureReason : failed due to

' Event Relationships
UserSession ..> LoginSucceededDomainEvent : raises
UserSession ..> SessionExpiredDomainEvent : raises
UserSession ..> LogoutInitiatedDomainEvent : raises

PasswordResetToken ..> PasswordResetRequestedDomainEvent : raises
PasswordResetToken ..> PasswordResetCompletedDomainEvent : raises

MfaConfiguration ..> MfaEnabledDomainEvent : raises
MfaConfiguration ..> MfaDisabledDomainEvent : raises

note right of UserSession
  Aggregate Root for user sessions.
  Manages authentication state,
  session lifecycle, and MFA verification.
end note

note right of PasswordResetToken
  Aggregate Root for password reset flow.
  Manages token lifecycle and validation.
  Tokens are single-use and time-limited.
end note

note right of MfaConfiguration
  Aggregate Root for MFA settings.
  Supports multiple MFA methods and
  includes backup codes for recovery.
end note

@enduml
