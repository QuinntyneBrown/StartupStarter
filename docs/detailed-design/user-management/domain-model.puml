@startuml User Management Domain Model

!define AGGREGATE_ROOT_COLOR #FFE4B5
!define ENTITY_COLOR #E0F2F7
!define VALUE_OBJECT_COLOR #F0E68C
!define ENUM_COLOR #D8BFD8

skinparam class {
    BackgroundColor<<AggregateRoot>> AGGREGATE_ROOT_COLOR
    BackgroundColor<<Entity>> ENTITY_COLOR
    BackgroundColor<<ValueObject>> VALUE_OBJECT_COLOR
    BackgroundColor<<Enum>> ENUM_COLOR
    BorderColor Black
    ArrowColor Black
}

package "User Management Domain" {

    ' Aggregate Root
    class User <<AggregateRoot>> {
        + UserId: Guid
        + Email: string
        + FirstName: string
        + LastName: string
        + AccountId: Guid
        + Status: UserStatus
        + IsLocked: bool
        + LockedAt: DateTime?
        + LockReason: string?
        + LockDuration: TimeSpan?
        + CreatedAt: DateTime
        + UpdatedAt: DateTime?
        + DeletedAt: DateTime?
        + IsDeleted: bool
        + CreatedBy: Guid
        --
        + {static} Create(): User
        + Update(): void
        + Activate(): void
        + Deactivate(): void
        + Lock(): void
        + Unlock(): void
        + ChangeAccount(): void
        + Delete(): void
    }

    ' Entity
    class UserInvitation <<Entity>> {
        + InvitationId: Guid
        + Email: string
        + AccountId: Guid
        + InvitedBy: Guid
        + Status: InvitationStatus
        + CreatedAt: DateTime
        + ExpiresAt: DateTime
        + AcceptedAt: DateTime?
        + AcceptedUserId: Guid?
        --
        + {static} Create(): UserInvitation
        + Accept(): void
        + Expire(): void
    }

    ' Entity
    class UserRole <<Entity>> {
        + UserRoleId: Guid
        + UserId: Guid
        + RoleName: string
        + AssignedAt: DateTime
        + AssignedBy: Guid
        --
        + {static} Create(): UserRole
    }

    ' Entity
    class InvitationRole <<Entity>> {
        + InvitationRoleId: Guid
        + InvitationId: Guid
        + RoleName: string
        --
        + {static} Create(): InvitationRole
    }

    ' Enumerations
    enum UserStatus <<Enum>> {
        Pending
        Active
        Inactive
        Suspended
    }

    enum ActivationMethod <<Enum>> {
        EmailVerification
        AdminActivation
        AutoActivation
    }

    enum InvitationStatus <<Enum>> {
        Pending
        Accepted
        Expired
        Cancelled
    }

    enum DeletionType <<Enum>> {
        SoftDelete
        HardDelete
    }

    ' External References
    class Account <<External>> {
        + AccountId: Guid
        + Name: string
    }

    ' Relationships
    User "1" *-- "many" UserRole : contains
    User --> UserStatus : has
    User --> Account : belongs to

    UserInvitation "1" *-- "many" InvitationRole : contains
    UserInvitation --> InvitationStatus : has
    UserInvitation --> Account : for
    UserInvitation ..> User : creates

    UserRole --> User : assigned to
    InvitationRole --> UserInvitation : part of
}

package "Domain Events" {
    abstract class DomainEvent {
        + EventId: Guid
        + OccurredAt: DateTime
    }

    class UserCreatedDomainEvent {
        + UserId: Guid
        + Email: string
        + FirstName: string
        + LastName: string
        + AccountId: Guid
        + CreatedBy: Guid
        + InitialRoles: List<string>
        + InvitationSent: bool
    }

    class UserUpdatedDomainEvent {
        + UserId: Guid
        + AccountId: Guid
        + UpdatedBy: Guid
        + UpdatedFields: Dictionary
        + PreviousValues: Dictionary
    }

    class UserActivatedDomainEvent {
        + UserId: Guid
        + AccountId: Guid
        + ActivatedBy: Guid
        + ActivationMethod: ActivationMethod
    }

    class UserDeactivatedDomainEvent {
        + UserId: Guid
        + AccountId: Guid
        + DeactivatedBy: Guid
        + Reason: string
    }

    class UserLockedDomainEvent {
        + UserId: Guid
        + AccountId: Guid
        + LockedBy: string
        + Reason: string
        + LockDuration: TimeSpan?
    }

    class UserUnlockedDomainEvent {
        + UserId: Guid
        + AccountId: Guid
        + UnlockedBy: Guid
    }

    class UserDeletedDomainEvent {
        + UserId: Guid
        + Email: string
        + AccountId: Guid
        + DeletedBy: Guid
        + DeletionType: DeletionType
        + Reason: string
    }

    class UserInvitationSentDomainEvent {
        + InvitationId: Guid
        + Email: string
        + AccountId: Guid
        + InvitedBy: Guid
        + Roles: List<string>
        + ExpiresAt: DateTime
    }

    class UserInvitationAcceptedDomainEvent {
        + InvitationId: Guid
        + UserId: Guid
        + Email: string
        + AccountId: Guid
    }

    class UserInvitationExpiredDomainEvent {
        + InvitationId: Guid
        + Email: string
        + AccountId: Guid
    }

    class UserAccountChangedDomainEvent {
        + UserId: Guid
        + PreviousAccountId: Guid
        + NewAccountId: Guid
        + ChangedBy: Guid
        + Reason: string
    }

    ' Event Inheritance
    DomainEvent <|-- UserCreatedDomainEvent
    DomainEvent <|-- UserUpdatedDomainEvent
    DomainEvent <|-- UserActivatedDomainEvent
    DomainEvent <|-- UserDeactivatedDomainEvent
    DomainEvent <|-- UserLockedDomainEvent
    DomainEvent <|-- UserUnlockedDomainEvent
    DomainEvent <|-- UserDeletedDomainEvent
    DomainEvent <|-- UserInvitationSentDomainEvent
    DomainEvent <|-- UserInvitationAcceptedDomainEvent
    DomainEvent <|-- UserInvitationExpiredDomainEvent
    DomainEvent <|-- UserAccountChangedDomainEvent

    ' Events raised by aggregates
    User ..> UserCreatedDomainEvent : raises
    User ..> UserUpdatedDomainEvent : raises
    User ..> UserActivatedDomainEvent : raises
    User ..> UserDeactivatedDomainEvent : raises
    User ..> UserLockedDomainEvent : raises
    User ..> UserUnlockedDomainEvent : raises
    User ..> UserDeletedDomainEvent : raises
    User ..> UserAccountChangedDomainEvent : raises

    UserInvitation ..> UserInvitationSentDomainEvent : raises
    UserInvitation ..> UserInvitationAcceptedDomainEvent : raises
    UserInvitation ..> UserInvitationExpiredDomainEvent : raises
}

note right of User
  Aggregate Root following DDD principles
  - Encapsulates business logic
  - Raises domain events
  - Ensures invariants
end note

note right of UserInvitation
  Manages invitation lifecycle
  - Tracks invitation status
  - Enforces expiration
  - Links to created user
end note

@enduml
