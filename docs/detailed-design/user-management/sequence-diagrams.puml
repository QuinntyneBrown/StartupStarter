@startuml User Management Sequence Diagrams

' ============================================================================
' 1. Create User Flow
' ============================================================================
@startuml Create User Flow

title Create User Flow

actor Admin
participant "API Controller" as API
participant "MediatR" as MediatR
participant "CreateUserHandler" as Handler
participant "User Aggregate" as User
participant "UserRepository" as Repo
participant "Event Dispatcher" as Events
participant "Email Service" as Email

Admin -> API: POST /api/users\n(CreateUserRequest)
activate API

API -> MediatR: Send(CreateUserCommand)
activate MediatR

MediatR -> Handler: Handle(CreateUserCommand)
activate Handler

Handler -> Handler: Validate command\n(email, account, roles)

Handler -> User: Create(email, firstName,\nlastName, accountId,\ncreatedBy, roles)
activate User

User -> User: Validate business rules
User -> User: Set initial status\n(Pending)
User -> User: AddDomainEvent\n(UserCreatedDomainEvent)
User --> Handler: User instance
deactivate User

Handler -> Repo: AddAsync(user)
activate Repo
Repo -> Repo: Add to DbContext
Repo --> Handler: Success
deactivate Repo

Handler -> Repo: SaveChangesAsync()
activate Repo
Repo -> Repo: Commit transaction
Repo -> Events: Dispatch domain events
activate Events
Events -> Events: Process\nUserCreatedDomainEvent
Events -> Email: Send welcome email\n(if invitation sent)
activate Email
Email --> Events: Email sent
deactivate Email
deactivate Events
Repo --> Handler: Success
deactivate Repo

Handler --> MediatR: CreateUserResponse\n(userId, status, createdAt)
deactivate Handler

MediatR --> API: CreateUserResponse
deactivate MediatR

API --> Admin: 201 Created\n(User details)
deactivate API

@enduml

' ============================================================================
' 2. Send Invitation Flow
' ============================================================================
@startuml Send Invitation Flow

title Send User Invitation Flow

actor Admin
participant "API Controller" as API
participant "MediatR" as MediatR
participant "SendInvitationHandler" as Handler
participant "UserInvitation" as Invitation
participant "InvitationRepository" as Repo
participant "Event Dispatcher" as Events
participant "Email Service" as Email

Admin -> API: POST /api/users/invitations\n(SendInvitationRequest)
activate API

API -> MediatR: Send(SendUserInvitationCommand)
activate MediatR

MediatR -> Handler: Handle(SendUserInvitationCommand)
activate Handler

Handler -> Handler: Validate email\nnot already invited

Handler -> Repo: GetByEmailAsync(email, accountId)
activate Repo
Repo --> Handler: null (no existing invitation)
deactivate Repo

Handler -> Invitation: Create(email, accountId,\ninvitedBy, roles, expiresAt)
activate Invitation

Invitation -> Invitation: Set expiration\n(7 days default)
Invitation -> Invitation: AddDomainEvent\n(UserInvitationSentDomainEvent)
Invitation --> Handler: Invitation instance
deactivate Invitation

Handler -> Repo: AddAsync(invitation)
activate Repo
Repo --> Handler: Success
deactivate Repo

Handler -> Repo: SaveChangesAsync()
activate Repo
Repo -> Events: Dispatch domain events
activate Events
Events -> Email: SendInvitationEmail\n(email, invitationId, link)
activate Email
Email -> Email: Generate invitation link
Email -> Email: Send email
Email --> Events: Email sent
deactivate Email
deactivate Events
Repo --> Handler: Success
deactivate Repo

Handler --> MediatR: SendUserInvitationResponse\n(invitationId, expiresAt)
deactivate Handler

MediatR --> API: SendUserInvitationResponse
deactivate MediatR

API --> Admin: 201 Created\n(Invitation details)
deactivate API

@enduml

' ============================================================================
' 3. Accept Invitation Flow
' ============================================================================
@startuml Accept Invitation Flow

title Accept User Invitation Flow

actor NewUser
participant "Public API" as API
participant "MediatR" as MediatR
participant "AcceptInvitationHandler" as Handler
participant "InvitationRepository" as InvRepo
participant "UserInvitation" as Invitation
participant "User Aggregate" as User
participant "UserRepository" as UserRepo
participant "Event Dispatcher" as Events
participant "Email Service" as Email

NewUser -> API: POST /api/invitations/{id}/accept\n(firstName, lastName, password)
activate API

API -> MediatR: Send(AcceptUserInvitationCommand)
activate MediatR

MediatR -> Handler: Handle(AcceptUserInvitationCommand)
activate Handler

Handler -> InvRepo: GetByIdAsync(invitationId)
activate InvRepo
InvRepo --> Handler: UserInvitation
deactivate InvRepo

Handler -> Handler: Validate invitation\n- not expired\n- not already accepted

Handler -> Invitation: Accept(userId)
activate Invitation
Invitation -> Invitation: Set status to Accepted
Invitation -> Invitation: Set acceptedAt
Invitation -> Invitation: AddDomainEvent\n(UserInvitationAcceptedDomainEvent)
Invitation --> Handler: Success
deactivate Invitation

Handler -> User: Create(email, firstName,\nlastName, accountId,\ncreatedBy: System,\nroles from invitation)
activate User
User -> User: AddDomainEvent\n(UserCreatedDomainEvent)
User --> Handler: User instance
deactivate User

Handler -> UserRepo: AddAsync(user)
activate UserRepo
UserRepo --> Handler: Success
deactivate UserRepo

Handler -> InvRepo: UpdateAsync(invitation)
activate InvRepo
InvRepo --> Handler: Success
deactivate InvRepo

Handler -> UserRepo: SaveChangesAsync()
activate UserRepo
UserRepo -> Events: Dispatch domain events
activate Events
Events -> Email: Send account created email
activate Email
Email --> Events: Email sent
deactivate Email
deactivate Events
UserRepo --> Handler: Success
deactivate UserRepo

Handler -> Handler: Auto-activate user\n(ActivationMethod.EmailVerification)

Handler -> User: Activate(userId, EmailVerification)
activate User
User -> User: Set status to Active
User -> User: AddDomainEvent\n(UserActivatedDomainEvent)
User --> Handler: Success
deactivate User

Handler -> UserRepo: SaveChangesAsync()
activate UserRepo
UserRepo --> Handler: Success
deactivate UserRepo

Handler --> MediatR: AcceptUserInvitationResponse\n(userId, email, accountId)
deactivate Handler

MediatR --> API: AcceptUserInvitationResponse
deactivate MediatR

API --> NewUser: 200 OK\n(User details, auth token)
deactivate API

@enduml

' ============================================================================
' 4. Activate/Deactivate User Flow
' ============================================================================
@startuml Activate Deactivate User Flow

title Activate/Deactivate User Flow

actor Admin
participant "API Controller" as API
participant "MediatR" as MediatR
participant "ActivateHandler" as ActivateHandler
participant "DeactivateHandler" as DeactivateHandler
participant "UserRepository" as Repo
participant "User Aggregate" as User
participant "Event Dispatcher" as Events
participant "Notification Service" as Notify

== Activate User ==

Admin -> API: POST /api/users/{id}/activate
activate API

API -> MediatR: Send(ActivateUserCommand)
activate MediatR

MediatR -> ActivateHandler: Handle(ActivateUserCommand)
activate ActivateHandler

ActivateHandler -> Repo: GetByIdAsync(userId)
activate Repo
Repo --> ActivateHandler: User
deactivate Repo

ActivateHandler -> ActivateHandler: Validate user exists\nand not already active

ActivateHandler -> User: Activate(activatedBy,\nActivationMethod.AdminActivation)
activate User
User -> User: Set status to Active
User -> User: AddDomainEvent\n(UserActivatedDomainEvent)
User --> ActivateHandler: Success
deactivate User

ActivateHandler -> Repo: UpdateAsync(user)
activate Repo
Repo --> ActivateHandler: Success
deactivate Repo

ActivateHandler -> Repo: SaveChangesAsync()
activate Repo
Repo -> Events: Dispatch domain events
activate Events
Events -> Notify: Notify user of activation
deactivate Events
Repo --> ActivateHandler: Success
deactivate Repo

ActivateHandler --> MediatR: Success
deactivate ActivateHandler

MediatR --> API: Success
deactivate MediatR

API --> Admin: 200 OK
deactivate API

== Deactivate User ==

Admin -> API: POST /api/users/{id}/deactivate\n(reason)
activate API

API -> MediatR: Send(DeactivateUserCommand)
activate MediatR

MediatR -> DeactivateHandler: Handle(DeactivateUserCommand)
activate DeactivateHandler

DeactivateHandler -> Repo: GetByIdAsync(userId)
activate Repo
Repo --> DeactivateHandler: User
deactivate Repo

DeactivateHandler -> DeactivateHandler: Validate user exists\nand is currently active

DeactivateHandler -> User: Deactivate(deactivatedBy, reason)
activate User
User -> User: Set status to Inactive
User -> User: AddDomainEvent\n(UserDeactivatedDomainEvent)
User --> DeactivateHandler: Success
deactivate User

DeactivateHandler -> Repo: UpdateAsync(user)
activate Repo
Repo --> DeactivateHandler: Success
deactivate Repo

DeactivateHandler -> Repo: SaveChangesAsync()
activate Repo
Repo -> Events: Dispatch domain events
activate Events
Events -> Notify: Notify user of deactivation
Events -> Events: Revoke active sessions
deactivate Events
Repo --> DeactivateHandler: Success
deactivate Repo

DeactivateHandler --> MediatR: Success
deactivate DeactivateHandler

MediatR --> API: Success
deactivate MediatR

API --> Admin: 200 OK
deactivate API

@enduml

' ============================================================================
' 5. Lock/Unlock User Flow
' ============================================================================
@startuml Lock Unlock User Flow

title Lock/Unlock User Flow

participant "Security System" as System
participant "Admin" as Admin
participant "API Controller" as API
participant "MediatR" as MediatR
participant "LockHandler" as LockHandler
participant "UnlockHandler" as UnlockHandler
participant "UserRepository" as Repo
participant "User Aggregate" as User
participant "Event Dispatcher" as Events
participant "Email Service" as Email

== Lock User (System - Failed Login Attempts) ==

System -> System: Detect failed login\nattempts >= threshold

System -> API: POST /api/users/{id}/lock\n(reason: "Failed login attempts",\nlockedBy: "System")
activate API

API -> MediatR: Send(LockUserCommand)
activate MediatR

MediatR -> LockHandler: Handle(LockUserCommand)
activate LockHandler

LockHandler -> Repo: GetByIdAsync(userId)
activate Repo
Repo --> LockHandler: User
deactivate Repo

LockHandler -> User: Lock("System", reason,\nlockDuration: 30 minutes)
activate User
User -> User: Set IsLocked = true
User -> User: Set lock details
User -> User: AddDomainEvent\n(UserLockedDomainEvent)
User --> LockHandler: Success
deactivate User

LockHandler -> Repo: UpdateAsync(user)
activate Repo
Repo --> LockHandler: Success
deactivate Repo

LockHandler -> Repo: SaveChangesAsync()
activate Repo
Repo -> Events: Dispatch domain events
activate Events
Events -> Email: Send security alert email
deactivate Events
Repo --> LockHandler: Success
deactivate Repo

LockHandler --> MediatR: Success
deactivate LockHandler

MediatR --> API: Success
deactivate MediatR

API --> System: 200 OK
deactivate API

== Lock User (Admin - Manual) ==

Admin -> API: POST /api/users/{id}/lock\n(reason: "Security violation",\nlockedBy: adminId)
activate API

API -> MediatR: Send(LockUserCommand)
activate MediatR

MediatR -> LockHandler: Handle(LockUserCommand)
activate LockHandler

LockHandler -> Repo: GetByIdAsync(userId)
activate Repo
Repo --> LockHandler: User
deactivate Repo

LockHandler -> User: Lock(adminId, reason,\nlockDuration: null)
activate User
User -> User: Set IsLocked = true
User -> User: Set lock details\n(permanent until unlocked)
User -> User: AddDomainEvent\n(UserLockedDomainEvent)
User --> LockHandler: Success
deactivate User

LockHandler -> Repo: SaveChangesAsync()
activate Repo
Repo -> Events: Dispatch domain events
activate Events
Events -> Email: Send account locked email
Events -> Events: Terminate active sessions
deactivate Events
Repo --> LockHandler: Success
deactivate Repo

LockHandler --> MediatR: Success
deactivate LockHandler

MediatR --> API: Success
deactivate MediatR

API --> Admin: 200 OK
deactivate API

== Unlock User ==

Admin -> API: POST /api/users/{id}/unlock
activate API

API -> MediatR: Send(UnlockUserCommand)
activate MediatR

MediatR -> UnlockHandler: Handle(UnlockUserCommand)
activate UnlockHandler

UnlockHandler -> Repo: GetByIdAsync(userId)
activate Repo
Repo --> UnlockHandler: User
deactivate Repo

UnlockHandler -> UnlockHandler: Validate user\nis currently locked

UnlockHandler -> User: Unlock(unlockedBy)
activate User
User -> User: Set IsLocked = false
User -> User: Clear lock details
User -> User: AddDomainEvent\n(UserUnlockedDomainEvent)
User --> UnlockHandler: Success
deactivate User

UnlockHandler -> Repo: UpdateAsync(user)
activate Repo
Repo --> UnlockHandler: Success
deactivate Repo

UnlockHandler -> Repo: SaveChangesAsync()
activate Repo
Repo -> Events: Dispatch domain events
activate Events
Events -> Email: Send account unlocked email
deactivate Events
Repo --> UnlockHandler: Success
deactivate Repo

UnlockHandler --> MediatR: Success
deactivate UnlockHandler

MediatR --> API: Success
deactivate MediatR

API --> Admin: 200 OK
deactivate API

@enduml

@enduml
