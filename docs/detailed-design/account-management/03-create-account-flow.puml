@startuml
title Account Management - Create Account Command Flow

actor User
participant "API Gateway" as API
participant "CommandController" as Controller
participant "MediatR ISender" as MediatR
participant "CreateAccountHandler" as Handler
participant "Account Aggregate" as Aggregate
participant "Event Store" as EventStore
participant "Event Publisher" as Publisher
queue "Event Bus" as EventBus
participant "Projection" as Projection
database "Read DB" as ReadDB

User -> API: POST /api/accounts
activate API

API -> Controller: CreateAccountCommand
activate Controller

note right of Controller
  Command:
  AccountName
  AccountType
  OwnerUserId
  SubscriptionTier
  CreatedBy
end note

Controller -> MediatR: Send(command)
activate MediatR

MediatR -> Handler: Handle(command)
activate Handler

Handler -> Handler: Validate command

note right of Handler
  Check required fields
  Validate business rules
  Check authorization
end note

Handler -> Aggregate: Create(id, name, type, ownerId, tier, createdBy)
activate Aggregate

Aggregate -> Aggregate: Apply business rules

note right of Aggregate
  Validate account type
  Validate subscription tier
  Check owner exists
end note

Aggregate -> Aggregate: Raise AccountCreated event

note right of Aggregate
  Event stored in uncommitted events
end note

Aggregate --> Handler: Account instance
deactivate Aggregate

Handler -> EventStore: AppendToStream(accountId, events)
activate EventStore

EventStore -> EventStore: Optimistic concurrency check
EventStore -> EventStore: Persist events
EventStore --> Handler: Success
deactivate EventStore

Handler -> Publisher: Publish(AccountCreated)
activate Publisher

Publisher -> EventBus: Send event
activate EventBus

note right of EventBus
  Async publication
  Fire and forget
end note

EventBus --> Publisher: Acknowledged
deactivate EventBus

Publisher --> Handler: Published
deactivate Publisher

Handler --> MediatR: CommandResult(accountId)
deactivate Handler

MediatR --> Controller: Result
deactivate MediatR

Controller --> API: 201 Created (accountId)
deactivate Controller

API --> User: Account created successfully
deactivate API

note over User, ReadDB
  === Async Projection Update ===
end note

EventBus -> Projection: AccountCreated event
activate Projection

Projection -> Projection: Transform to read model

note right of Projection
  Convert domain event
  to read model structure
end note

Projection -> ReadDB: INSERT AccountReadModel
activate ReadDB
ReadDB --> Projection: Success
deactivate ReadDB

Projection --> EventBus: ACK
deactivate Projection

note over User, ReadDB
  Read model is now eventually consistent
  Queries will reflect the new account
end note

@enduml
