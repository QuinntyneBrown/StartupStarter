@startuml
title Account Management - Azure Deployment Architecture

skinparam componentStyle rectangle

cloud "Azure Cloud" {
    
    package "API Layer" {
        node "Azure Kubernetes Service (AKS)" as AKS {
            component "API Gateway" as Gateway
            
            component "Command API Pods" as CmdAPI {
                [Account Command Service]
                [3-10 pods auto-scaling]
            }
            
            component "Query API Pods" as QryAPI {
                [Account Query Service]
                [5-15 pods auto-scaling]
            }
        }
    }
    
    package "Event Store" {
        database "Event Store DB" as EventStoreDB {
            [Account Event Streams]
            [Snapshots]
            [Metadata]
        }
    }
    
    package "Read Models" {
        database "Cosmos DB" as CosmosDB {
            [Account Read Models]
            [Denormalized Views]
            [Optimized for Queries]
        }
        
        database "Azure Cache for Redis" as Redis {
            [Hot Data Cache]
            [Query Results]
            [Session State]
        }
    }
    
    package "Message Bus" {
        queue "Azure Service Bus" as ServiceBus {
            [Domain Events Topic]
            [Subscription per BC]
            [Dead Letter Queue]
        }
    }
    
    package "Event Processing" {
        component "Projection Workers" as Projections {
            [Account Projections]
            [Process Events]
            [Update Read Models]
            [3 pods]
        }
        
        component "Event Handlers" as Handlers {
            [Integration Events]
            [External BC Updates]
            [Saga Coordinators]
        }
    }
    
    package "Monitoring and Observability" {
        component "Azure Monitor" as Monitor {
            [Application Insights]
            [Log Analytics]
            [Metrics]
        }
        
        component "Health Checks" as Health {
            [Liveness Probes]
            [Readiness Probes]
            [Startup Probes]
        }
    }
    
    package "Security" {
        component "Azure AD B2C" as AAD {
            [Authentication]
            [Authorization]
            [JWT Tokens]
        }
        
        component "Key Vault" as KeyVault {
            [Secrets]
            [Connection Strings]
            [Certificates]
        }
    }
}

Gateway --> CmdAPI
Gateway --> QryAPI

CmdAPI --> EventStoreDB
CmdAPI --> ServiceBus

QryAPI --> CosmosDB
QryAPI --> Redis

ServiceBus --> Projections
ServiceBus --> Handlers

Projections --> CosmosDB
Projections --> Redis

CmdAPI --> AAD
QryAPI --> AAD

CmdAPI --> KeyVault
QryAPI --> KeyVault

CmdAPI --> Monitor
QryAPI --> Monitor
Projections --> Monitor

CmdAPI --> Health
QryAPI --> Health

note right of EventStoreDB
    EventStoreDB or Cosmos DB:
    - Append-only streams
    - Optimistic concurrency
    - Stream per aggregate
    - Snapshot support
    - 99.99% SLA
end note

note right of CosmosDB
    Cosmos DB Features:
    - Global distribution
    - Multi-region writes
    - Automatic indexing
    - 99.999% availability
    - Configurable consistency
end note

note right of ServiceBus
    Service Bus:
    - Pub/Sub messaging
    - At-least-once delivery
    - Message sessions
    - Duplicate detection
    - Auto-forwarding
end note

note bottom of AKS
    Kubernetes Features:
    - Horizontal Pod Autoscaling
    - Resource limits and requests
    - Rolling updates
    - Blue-green deployments
    - Service mesh optional
    - Network policies
end note

legend right
    Infrastructure Characteristics:
    
    Scalability:
    - Command API: 3-10 pods
    - Query API: 5-15 pods (read-heavy)
    - Projections: 3 pods with competing consumers
    
    High Availability:
    - Multi-zone deployment
    - 99.95% SLA (AKS)
    - 99.99% SLA (Cosmos DB)
    - Active-active read replicas
    
    Performance:
    - Redis cache (sub-ms latency)
    - Cosmos DB (single-digit ms)
    - Event Store (optimized writes)
    
    Security:
    - Network isolation (VNets)
    - Private endpoints
    - Managed identities
    - Secrets in Key Vault
    - TLS everywhere
endlegend

@enduml
