@startuml
title Account Management - CQRS Architecture

skinparam component {
    BackgroundColor White
    BorderColor Black
}

package "Command Side - Write Model" {
    
    component "API Controllers" as CommandAPI {
        [AccountCommandController]
    }
    
    component "MediatR v12.x" as MediatR1 {
        [IRequestHandler Interface]
        [ISender]
        [Publisher]
    }
    
    component "Command Handlers" as CommandHandlers {
        [CreateAccountHandler]
        [UpdateAccountHandler]
        [DeleteAccountHandler]
        [SuspendAccountHandler]
        [ReactivateAccountHandler]
        [ChangeSubscriptionHandler]
        [ChangeOwnerHandler]
        [UpdateSettingsHandler]
        [AddProfileHandler]
        [RemoveProfileHandler]
    }
    
    component "Domain Model" as Domain {
        [Account Aggregate]
        [Domain Events]
        [Business Rules]
    }
    
    database "Event Store" as EventStore {
        [Account Event Streams]
        [Snapshots]
    }
    
    queue "Event Publisher" as EventPublisher {
        [Message Bus]
        [Event Dispatcher]
    }
    
    CommandAPI --> MediatR1
    MediatR1 --> CommandHandlers
    CommandHandlers --> Domain
    Domain --> EventStore
    EventStore --> EventPublisher
}

package "Query Side - Read Model" {
    
    component "API Controllers" as QueryAPI {
        [AccountQueryController]
    }
    
    component "MediatR v12.x" as MediatR2 {
        [IRequestHandler Interface]
        [ISender]
    }
    
    component "Query Handlers" as QueryHandlers {
        [GetAccountByIdHandler]
        [GetAccountsByOwnerHandler]
        [GetAccountsByTypeHandler]
        [GetAccountsByStatusHandler]
        [SearchAccountsHandler]
    }
    
    component "Read Models" as ReadModels {
        [AccountReadModel]
        [AccountListReadModel]
        [AccountSummaryReadModel]
    }
    
    database "Read Database" as ReadDB {
        [Cosmos DB / SQL]
        [Optimized for queries]
        [Denormalized views]
    }
    
    component "Projections" as Projections {
        [AccountProjection]
        [AccountListProjection]
        [AccountSummaryProjection]
    }
    
    QueryAPI --> MediatR2
    MediatR2 --> QueryHandlers
    QueryHandlers --> ReadModels
    ReadModels --> ReadDB
    
    EventPublisher --> Projections
    Projections --> ReadDB
}

package "External Integration" {
    component "Event Subscribers" as Subscribers {
        [User Management BC]
        [Profile Management BC]
        [Billing BC]
        [Audit Log Service]
        [Notification Service]
    }
    
    EventPublisher --> Subscribers
}

note right of CommandHandlers
  Command Handlers
  Validate command
  Load aggregate from event store
  Execute domain logic
  Persist events
  Return result
end note

note right of Projections
  Eventually Consistent
  Events published async
  Read models updated by projections
  Small delay acceptable
  Eventual consistency guaranteed
end note

note left of Domain
  Domain Layer
  Pure business logic
  No infrastructure dependencies
  Event sourced aggregates
  Enforces invariants
end note

note top of MediatR1
  MediatR v12.4.1 (Free Version)
  IRequestHandler<TRequest, TResponse>
  INotificationHandler<TNotification>
  ISender for sending requests
  IPublisher for publishing notifications
end note

@enduml
