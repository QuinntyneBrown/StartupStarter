@startuml
title Account Management - Clean Architecture Layers

skinparam componentStyle rectangle

package "Presentation Layer" {
    component "REST API Controllers" as Controllers {
        [AccountCommandController]
        [AccountQueryController]
    }
    
    component "Request/Response DTOs" as DTOs {
        [CreateAccountRequest]
        [UpdateAccountRequest]
        [AccountResponse]
        [AccountListResponse]
    }
    
    component "API Middleware" as Middleware {
        [Authentication]
        [Authorization]
        [Validation]
        [Exception Handling]
    }
}

package "Application Layer" {
    component "MediatR v12.x" as MediatR {
        [IRequestHandler<TRequest, TResponse>]
        [INotificationHandler<TNotification>]
        [ISender]
        [IPublisher]
    }
    
    component "Command Handlers" as CmdHandlers {
        [CreateAccountHandler]
        [UpdateAccountHandler]
        [DeleteAccountHandler]
        [SuspendAccountHandler]
        [etc...]
    }
    
    component "Query Handlers" as QryHandlers {
        [GetAccountByIdHandler]
        [GetAccountsByOwnerHandler]
        [SearchAccountsHandler]
    }
    
    component "Application Services" as AppServices {
        [AccountApplicationService]
        [Orchestrates use cases]
        [Transaction management]
    }
    
    interface "IEventStore" as IEventStore
    interface "IRepository" as IRepository
    interface "IEventPublisher" as IEventPublisher
    interface "IReadModelRepository" as IReadRepo
}

package "Domain Layer" {
    component "Aggregates" as Aggregates {
        [Account (Aggregate Root)]
        [Business logic]
        [Invariants enforcement]
    }
    
    component "Value Objects" as VOs {
        [AccountId]
        [UserId]
        [ProfileId]
        [AccountSettings]
    }
    
    component "Domain Events" as Events {
        [AccountCreated]
        [AccountUpdated]
        [AccountDeleted]
        [AccountSuspended]
        [etc...]
    }
    
    component "Domain Services" as DomainServices {
        [AccountDomainService]
        [Complex business rules]
        [Cross-aggregate operations]
    }
    
    component "Specifications" as Specs {
        [Business rule validation]
        [Reusable conditions]
    }
}

package "Infrastructure Layer" {
    component "Event Store Implementation" as EventStoreImpl {
        [EventStoreDbEventStore]
        [CosmosDbEventStore]
        [SqlEventStore]
    }
    
    component "Event Publisher Implementation" as PublisherImpl {
        [AzureServiceBusPublisher]
        [RabbitMqPublisher]
        [KafkaPublisher]
    }
    
    component "Repository Implementation" as RepoImpl {
        [CosmosDbRepository]
        [SqlRepository]
        [Cache layer]
    }
    
    component "Read Model Repository" as ReadRepoImpl {
        [AccountReadRepository]
        [Optimized queries]
        [Denormalized data]
    }
    
    component "External Services" as External {
        [Email service]
        [Notification service]
        [Audit logging]
    }
}

Controllers --> MediatR
Controllers --> DTOs

MediatR --> CmdHandlers
MediatR --> QryHandlers
CmdHandlers --> AppServices
QryHandlers --> IReadRepo
AppServices --> Aggregates
AppServices --> IEventStore
AppServices --> IEventPublisher

Aggregates --> VOs
Aggregates --> Events
Aggregates --> Specs

IEventStore <|.. EventStoreImpl
IEventPublisher <|.. PublisherImpl
IRepository <|.. RepoImpl
IReadRepo <|.. ReadRepoImpl

EventStoreImpl --> External
PublisherImpl --> External

note right of "Domain Layer"
  Domain Layer:
  No dependencies on outer layers
  Pure business logic
  Framework agnostic
  Easily testable
  Heart of the application
end note

note right of "Application Layer"
  Application Layer:
  Orchestrates use cases
  Depends only on Domain
  Defines interfaces
  Transaction boundaries
  Security enforcement
  
  MediatR v12.4.1 (Free):
  Install-Package MediatR
  Install-Package MediatR.Extensions.Microsoft.DependencyInjection
end note

note right of "Infrastructure Layer"
  Infrastructure Layer:
  Implements interfaces
  External concerns
  Database access
  Message bus
  Third-party services
  Configuration
end note

note left of Controllers
  Presentation Layer:
  HTTP/REST concerns
  Request/response mapping
  Authentication/Authorization
  API versioning
  OpenAPI/Swagger
end note

@enduml
